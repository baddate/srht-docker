# sr.ht-container-compose

# Setup

The first time sr.ht-container-compose is used, sr.ht sources need to be cloned
locally:

    make init

Then sr.ht can be built and started:

    docker compose watch

Any changes to the sr.ht sources will rebuild and reload sr.ht containers as
needed.

# Usage

A default admin "root" is created, with password "root" and a personal access
token. A configuration file for [hut] is available in `hut-config`.

The following services are included:

- meta.sr.ht: web frontend at http://127.0.0.1:5000
- todo.sr.ht: web frontend at http://127.0.0.1:5003,
  SMTP server at 127.0.0.1:5903 accepting mails for @todo
- git.sr.ht: web frontend at http://127.0.0.1:5001,
  SSH access at ssh://git@127.0.0.1:5901
- man.sr.ht: web frontend at http://127.0.0.1:5004
- lists.sr.ht: web frontend at http://127.0.0.1:5006
  SMTP server at 127.0.0.1:5906 accepting mails for ~$USER/$LIST@lists.sr.ht
- paste.sr.ht: web frontend at http://127.0.0.1:5011
- hub.sr.ht: web frontend at http://127.0.0.1:5014
- minio: web frontend at http://127.0.0.1:9001,
  username: minio, password: jIPk1RZ8gdhQwnUL4YtrOAXsFpHvb4Mw8hEwfLq

By default, all services are started. To only start a subset, specify services
of interest as arguments, for instance:

    docker compose up --attach-dependencies todo

To pull changes from all repositories:

    make pull

[hut]: https://sr.ht/~xenrox/hut/

# Caveats

Generated code is built inside the containers, so it won't be accessible from
the host. Because of this, development tools will indicate that (autogenerated)
type definitions are missing.

# Service specific how-to

## Create new users

You can either modify `init-postgres.sh`, which is tedious and requires you to
drop the `srht-postgres-data` volume whenever you need a new user, or use
the `meta` container as follows:

- Go to [http://127.0.0.1:5000/register](http://127.0.0.1:5000/register)
- Fill your new user's information and Submit
- Since the service is not setup to receive/send emails, you'll have to force
  the registration completion like this:
    - Login as `root`
    - Go to [127.0.0.1:5000/users](http://127.0.0.1:5000/users)
    - Click on the user just created
    - Change the status from `PENDING` to `USER` and Submit
- You can now login as that new user

## Populate lists.sr.ht with real data

[Optional] If you want to simulate the integration between the mail data and
actual users, you will need to create users via [127.0.0.1:5000](http://127.0.0.1:5000)
that have the appropriate email address setup.

Data can be ingested in the following two ways.

### Import data from existing list

(We assume that the existing list is on lists.sr.ht; instructions can be easily
tweaked for other providers.)

- Step 1: Export one of your lists from [lists.sr.ht](https://lists.sr.ht) via
  settings => import/export => Export mail spool
- Step 2: Import it into [127.0.0.1:5006](http://127.0.0.1:5006) via settings
  => import/export => Import mail spool

### Send new emails to the list

This is very easy using the `contrib/send_email.py` script. Examples of usage can
be found at the top of the script.
